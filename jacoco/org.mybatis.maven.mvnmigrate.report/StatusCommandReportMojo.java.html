<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatusCommandReportMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis Migrations Maven plugin</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.maven.mvnmigrate.report</a> &gt; <span class="el_source">StatusCommandReportMojo.java</span></div><h1>StatusCommandReportMojo.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2010-2024 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.maven.mvnmigrate.report;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;

import org.apache.ibatis.migration.Change;
import org.apache.ibatis.migration.commands.StatusCommand;
import org.apache.ibatis.migration.operations.StatusOperation;
import org.apache.ibatis.migration.options.SelectedOptions;
import org.apache.maven.doxia.sink.Sink;
import org.apache.maven.doxia.siterenderer.Renderer;
import org.apache.maven.model.ReportPlugin;
import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.project.MavenProject;
import org.apache.maven.reporting.AbstractMavenReport;
import org.apache.maven.reporting.MavenReportException;
import org.codehaus.plexus.util.xml.Xpp3Dom;

/**
 * Extends {@link AbstractMavenReport}. &lt;br&gt;
 * Class to generate a Maven report.
 */
@Mojo(name = &quot;status-report&quot;)
<span class="nc" id="L45">public final class StatusCommandReportMojo extends AbstractMavenReport {</span>

<span class="nc" id="L47">  private static final File DEFAULT_REPO = new File(&quot;.&quot;);</span>

  private static final String DEFAULT_ENVIRONMENT = &quot;development&quot;;

  private static final boolean DEFAULT_FORCE = false;

  /**
   * The Maven project to analyze.
   */
  @Parameter(property = &quot;project&quot;, required = true, readonly = true)
  private MavenProject project;

  /**
   * Target folder.
   */
  @Parameter(property = &quot;project.build.directory&quot;, readonly = true)
  private File outputDirectory;

  /**
   * The projects in the reactor for aggregation report.
   */
  @Parameter(property = &quot;reactorProjects&quot;, readonly = true)
  protected List&lt;MavenProject&gt; reactorProjects;

  /**
   * The project site renderer.
   */
  @Component(role = Renderer.class)
  private Renderer siteRenderer;

  /**
   * Location of migrate repository.
   */
  @Parameter(property = &quot;migration.path&quot;, defaultValue = &quot;.&quot;)
  protected File repository;

  /**
   * Environment to configure. Default environment is 'development'.
   */
  @Parameter(property = &quot;migration.env&quot;, defaultValue = &quot;development&quot;)
  protected String environment;

  /**
   * Forces script to continue even if SQL errors are encountered.
   */
  @Parameter(property = &quot;migration.force&quot;, defaultValue = &quot;false&quot;)
  protected boolean force;

  /**
   * Skip migration actions.
   */
  @Parameter(property = &quot;migration.skip&quot;, defaultValue = &quot;false&quot;)
  protected boolean skip;

  /**
   * Aggregate report results.
   */
  @Parameter(property = &quot;migration.aggregate&quot;, defaultValue = &quot;false&quot;)
  protected boolean aggregate;

  @Override
  protected void executeReport(Locale locale) throws MavenReportException {
<span class="nc bnc" id="L109" title="All 4 branches missed.">    if (aggregate &amp;&amp; !project.isExecutionRoot()) {</span>
<span class="nc" id="L110">      return;</span>
    }

<span class="nc bnc" id="L113" title="All 4 branches missed.">    if (skip &amp;&amp; !aggregate) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">      if (this.getLog().isInfoEnabled()) {</span>
<span class="nc" id="L115">        this.getLog().info(getBundle(locale).getString(&quot;migration.status.report.skipped&quot;));</span>
      }
<span class="nc" id="L117">      return;</span>
    }

    // Step 0: Checking pom availability
<span class="nc bnc" id="L121" title="All 4 branches missed.">    if (&quot;pom&quot;.equals(this.project.getPackaging()) &amp;&amp; !aggregate) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">      if (this.getLog().isInfoEnabled()) {</span>
<span class="nc" id="L123">        this.getLog().info(&quot;migration.status.report.skipped.pom&quot;);</span>
      }
<span class="nc" id="L125">      return;</span>
    }

<span class="nc bnc" id="L128" title="All 4 branches missed.">    if (this.outputDirectory == null || !this.outputDirectory.exists()) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">      if (this.getLog().isInfoEnabled()) {</span>
<span class="nc" id="L130">        this.getLog().info(</span>
<span class="nc" id="L131">            getBundle(locale).getString(getBundle(locale).getString(&quot;migration.status.report.skipped.no.target&quot;)));</span>
      }
<span class="nc" id="L133">      return;</span>
    }

<span class="nc" id="L136">    Map&lt;MavenProject, List&lt;Change&gt;&gt; aggregateReport = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">    for (MavenProject mavenProject : reactorProjects) {</span>

<span class="nc" id="L140">      Map&lt;String, ReportPlugin&gt; reportPluginMap = mavenProject.getModel().getReporting().getReportPluginsAsMap();</span>
<span class="nc" id="L141">      ReportPlugin plug = reportPluginMap.get(getBundle(locale).getString(&quot;migration.plugin.key&quot;));</span>

<span class="nc" id="L143">      Xpp3Dom configurationDom = (Xpp3Dom) plug.getConfiguration();</span>

<span class="nc" id="L145">      File reactorRepo = DEFAULT_REPO;</span>
<span class="nc" id="L146">      String reactorEnv = DEFAULT_ENVIRONMENT;</span>
<span class="nc" id="L147">      boolean reactorForce = DEFAULT_FORCE;</span>
<span class="nc" id="L148">      boolean skipStatusCommand = false;</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">      for (int i = 0; i &lt; configurationDom.getChildCount(); i++) {</span>
<span class="nc" id="L151">        Xpp3Dom child = configurationDom.getChild(i);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (&quot;repository&quot;.equalsIgnoreCase(child.getName())) {</span>
<span class="nc" id="L153">          reactorRepo = new File(child.getValue());</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (&quot;environment&quot;.equalsIgnoreCase(child.getName())) {</span>
<span class="nc" id="L155">          reactorEnv = child.getValue();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        } else if (&quot;force&quot;.equalsIgnoreCase(child.getName())) {</span>
<span class="nc" id="L157">          reactorForce = Boolean.valueOf(child.getValue());</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        } else if (&quot;skip&quot;.equalsIgnoreCase(child.getName())) {</span>
<span class="nc" id="L159">          skipStatusCommand = Boolean.valueOf(child.getValue());</span>
        }
      }

<span class="nc bnc" id="L163" title="All 2 branches missed.">      if (skipStatusCommand) {</span>
<span class="nc" id="L164">        continue;</span>
      }

<span class="nc" id="L167">      final SelectedOptions options = new SelectedOptions();</span>
<span class="nc" id="L168">      options.getPaths().setBasePath(reactorRepo);</span>
<span class="nc" id="L169">      options.setEnvironment(reactorEnv);</span>
<span class="nc" id="L170">      options.setForce(reactorForce);</span>

<span class="nc" id="L172">      StatusCommand analyzer = new StatusCommand(options);</span>
      try {
<span class="nc" id="L174">        analyzer.execute();</span>
<span class="nc" id="L175">        StatusOperation operation = analyzer.getOperation();</span>
<span class="nc" id="L176">        List&lt;Change&gt; analysis = operation.getCurrentStatus();</span>

<span class="nc" id="L178">        aggregateReport.put(mavenProject, analysis);</span>
<span class="nc" id="L179">      } catch (RuntimeException e) {</span>
<span class="nc" id="L180">        throw e;</span>
<span class="nc" id="L181">      } catch (Exception e) {</span>
<span class="nc" id="L182">        throw new MavenReportException(getBundle(locale).getString(&quot;migration.status.report.error&quot;), e);</span>
<span class="nc" id="L183">      }</span>
<span class="nc" id="L184">    }</span>

    // Step 2: Create sink and bundle
<span class="nc" id="L187">    Sink sink = getSink();</span>
<span class="nc" id="L188">    ResourceBundle bundle = getBundle(locale);</span>

    // Step 3: Generate the report
<span class="nc" id="L191">    MigrationStatusReportView view = new MigrationStatusReportView();</span>
<span class="nc" id="L192">    view.generateReport(aggregateReport, sink, bundle, aggregate);</span>
<span class="nc" id="L193">  }</span>

  @Override
  protected String getOutputDirectory() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">    if (this.getLog().isInfoEnabled()) {</span>
<span class="nc" id="L198">      this.getLog().info(outputDirectory.toString());</span>
    }
<span class="nc" id="L200">    return this.outputDirectory.toString();</span>
  }

  @Override
  protected MavenProject getProject() {
<span class="nc" id="L205">    return this.project;</span>
  }

  @Override
  protected Renderer getSiteRenderer() {
<span class="nc" id="L210">    return this.siteRenderer;</span>
  }

  /**
   * Return the output name of the report.
   *
   * @return the output name.
   */
  @Override
  public String getOutputName() {
<span class="nc" id="L220">    return &quot;migration-status-analysis&quot;;</span>
  }

  /**
   * Return the name of the report.
   *
   * @return the name of the report.
   */
  @Override
  public String getName(Locale locale) {
<span class="nc" id="L230">    return getBundle(locale).getString(&quot;migration.status.report.name&quot;);</span>
  }

  /**
   * Return the description of the report.
   *
   * @return the description of the report.
   */
  @Override
  public String getDescription(Locale locale) {
<span class="nc" id="L240">    return getBundle(locale).getString(&quot;migration.status.report.description&quot;);</span>
  }

  /**
   * Return the {@link ResourceBundle} given the current locale.
   *
   * @param locale
   *          the current locale.
   */
  protected ResourceBundle getBundle(Locale locale) {
<span class="nc" id="L250">    return ResourceBundle.getBundle(&quot;migration-report&quot;, locale, this.getClass().getClassLoader());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>